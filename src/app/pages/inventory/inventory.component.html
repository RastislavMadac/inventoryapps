<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Invent√∫ra</ion-title>
    
    <ion-chip *ngIf="aktivnaInventura" slot="end" class="inv-chip">
      <ion-icon name="clipboard-outline"></ion-icon>
      <ion-label>{{ aktivnaInventura.nazov }}</ion-label>
    </ion-chip>
  </ion-toolbar>

  <ion-toolbar color="primary" class="toolbar-segment">
    <ion-segment [value]="rezimZobrazenia" (ionChange)="zmenitRezim($event)" mode="ios">
      <ion-segment-button value="regal">
        <ion-label>Po Reg√°loch</ion-label>
      </ion-segment-button>
      <ion-segment-button value="global">
        <ion-label>V≈°etky</ion-label>
      </ion-segment-button>
      <ion-segment-button value="v_inventure" *ngIf="aktivnaInventura">
        <ion-label>Hotov√©</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <div class="filter-panel">
    
    <div class="ion-padding-horizontal reset-container" 
         style="display: flex; justify-content: center; width: 100%;"
         *ngIf="vybranySkladId || searchQuery || (filterKategoria && filterKategoria !== 'vsetky')">
      
      <ion-chip color="danger" mode="ios" (click)="zrusitFiltre()">
        <ion-icon name="close-circle"></ion-icon>
        <ion-label>Zru≈°i≈• filtre</ion-label>
      </ion-chip>

    </div>

    <div class="select-row fade-in">
      
      <div class="select-wrapper">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
          <span class="input-label" style="margin-bottom: 0;">Sklad</span>
          
          <ion-icon *ngIf="rezimZobrazenia !== 'global'" 
                    name="add-circle-outline" color="primary" style="font-size: 20px;" 
                    (click)="otvoritNovuLokaciu()">
          </ion-icon>
        </div>
        
        <div class="custom-input-box" [class.disabled]="rezimZobrazenia === 'global'">
          <ion-select placeholder="Vyberte" interface="action-sheet"
                      [(ngModel)]="vybranySkladId" 
                      (ionChange)="priZmeneSkladu()"
                      [disabled]="rezimZobrazenia === 'global'">
             <ion-select-option *ngFor="let s of sklady" [value]="s.id">{{ s.nazov }}</ion-select-option>
          </ion-select>
          <ion-icon name="caret-down-outline"></ion-icon>
        </div>
      </div>

      <div class="select-wrapper">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
          <span class="input-label" style="margin-bottom: 0;">Reg√°l</span>
          
          <ion-icon *ngIf="rezimZobrazenia !== 'global'" 
                    name="add-circle-outline" color="primary" style="font-size: 20px;" 
                    (click)="otvoritNovuLokaciu()">
          </ion-icon>
        </div>
        
        <div class="custom-input-box" [class.disabled]="!vybranySkladId || rezimZobrazenia === 'global'">
          <ion-select placeholder="Vyberte" interface="action-sheet"
                      [(ngModel)]="vybranyRegalId" 
                      (ionChange)="priZmeneRegalu()"  
                      [disabled]="!vybranySkladId || rezimZobrazenia === 'global'">
             <ion-select-option *ngFor="let r of filtrovaneRegaly" [value]="r.id">{{ r.nazov }}</ion-select-option>
          </ion-select>
          <ion-icon name="caret-down-outline"></ion-icon>
        </div>
      </div>
    </div>

      
    <div *ngIf="(rezimZobrazenia === 'regal' && vybranyRegalId) || rezimZobrazenia !== 'regal'" class="search-row fade-in">
      
      <div class="search-wrapper">
        <ion-icon name="search-outline" class="search-icon"></ion-icon>
        <input type="text" placeholder="Hƒæada≈• produkt..." 
               [(ngModel)]="searchQuery" 
               (input)="handleSearch($event)">
      </div>

      <div class="filter-btn-wrapper">
        <div class="icon-box">
          <ion-icon name="filter-outline"></ion-icon>
          <ion-select interface="action-sheet" 
                      [(ngModel)]="filterKategoria" 
                      (ionChange)="zmenitFilterKategorie($event)">
             <ion-select-option value="vsetky">V≈°etky</ion-select-option>
             <ion-select-option *ngFor="let k of unikatneKategorie" [value]="k">{{ k }}</ion-select-option>
          </ion-select>
        </div>
      </div>
    </div>

  </div>
</ion-header>

<ion-content #content [fullscreen]="true" class="bg-gray">

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="center-content" *ngIf="isLoading">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Naƒç√≠tavam...</p>
  </div>

  <div *ngIf="rezimZobrazenia === 'regal' && !vybranyRegalId && !isLoading" class="center-content empty-state fade-in">
    <div class="circle-icon">
      <ion-icon name="arrow-up-outline"></ion-icon>
    </div>
    <h3>Zaƒçnite v√Ωberom</h3>
    <p>Hore vyberte Sklad a Reg√°l pre zobrazenie tovaru.</p>
  </div>

  <div *ngIf="filtrovaneZasoby.length === 0 && !isLoading && (vybranyRegalId || rezimZobrazenia !== 'regal')" class="center-content empty-state fade-in">
    <div class="circle-icon green-icon">
      <ion-icon [name]="rezimZobrazenia === 'v_inventure' ? 'checkmark-done-outline' : 'search-outline'"></ion-icon>
    </div>
    <h3 *ngIf="rezimZobrazenia === 'v_inventure'">Zatiaƒæ niƒç zap√≠san√©</h3>
    <h3 *ngIf="rezimZobrazenia !== 'v_inventure'">≈Ωiadne polo≈æky</h3>
    
    <p *ngIf="rezimZobrazenia === 'v_inventure'">V tejto invent√∫re ste e≈°te nepotvrdili ≈æiadny tovar.</p>
    <p *ngIf="rezimZobrazenia !== 'v_inventure'">Nena≈°li sa ≈æiadne produkty zodpovedaj√∫ce filtru.</p>
  </div>

  <div class="cards-list" *ngIf="!isLoading">
    
    <ion-card *ngFor="let z of filtrovaneZasoby; trackBy: trackByZasoby" 
    [id]="'polozka-' + z.id"
    class="product-card">
              
      <ion-card-content>
        
        <div class="card-container">

          <div class="card-left">
             <div class="icon-placeholder" [class.done]="z.v_inventure">
               <ion-icon [name]="z.v_inventure ? 'checkmark-circle' : 'cube-outline'"></ion-icon>
             </div>
             
             <div class="info">
               <div (click)="otvoritUpravu(z)">
                 <h3>
                   {{ z.nazov }}
                   <span class="action-icons">
                     <ion-icon 
                       *ngIf="(jeAdmin || rezimZobrazenia === 'v_inventure') && (z.id > 0 || z.v_inventure)"
                        name="trash-outline" color="danger" class="trash-icon"
                        (click)="zmazatPolozku(z, $event)">
                     </ion-icon>
                   </span>
                 </h3>
               </div>

               <div class="meta">
                  <span class="badge-cat">{{ z.kategoria || 'Bez kat.' }}</span>
                  <span *ngIf="z.balenie_ks > 0" class="badge-pack">üì¶ {{ z.balenie_ks }}</span>
               </div>
               
               <p *ngIf="z.v_inventure" class="done-text">
                 <ion-icon name="checkmark-done-outline"></ion-icon> Zap√≠san√©
               </p>
               
               <p *ngIf="z.umiestnenie && !z.v_inventure" class="loc">
                 <ion-icon name="location-outline"></ion-icon> {{ z.umiestnenie }}
               </p>
             </div>
          </div>

          <div class="card-right">
            <div (click)="otvoritUpravu(z)">
               <span class="qty">{{ z.mnozstvo_ks }}</span>
               <small>{{ z.jednotka || 'ks' }}</small>
            </div>
            
            <ion-button fill="clear" (click)="upravitProduktDetail(z); $event.stopPropagation()">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
          </div>

        </div> </ion-card-content>
    </ion-card>

  </div>
  
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" style="margin-bottom: calc(15px + var(--ion-safe-area-bottom))">
    <ion-fab-button (click)="otvoritNovyProdukt()" color="primary">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>