<ion-header class="ion-no-border">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/home" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Invent√∫ra</ion-title>
    
    <ion-buttons slot="end">
      <ion-chip *ngIf="aktivnaInventura" class="inv-chip" style="margin-right: 8px;">
        <ion-icon name="clipboard-outline"></ion-icon>
        <ion-label>{{ aktivnaInventura.nazov }}</ion-label>
      </ion-chip>

      <ion-button (click)="toggleReorder()" 
                  *ngIf="rezimZobrazenia === 'regal' && vybranyRegalId && !searchQuery && filterKategoria === 'vsetky'"
                  color="light">
        <ion-icon slot="icon-only" [name]="isReorderDisabled ? 'reorder-four-outline' : 'checkmark-circle-outline'"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar color="primary" class="toolbar-segment">
    <ion-segment [value]="rezimZobrazenia" (ionChange)="zmenitRezim($event)" mode="ios">
      <ion-segment-button value="regal">
        <ion-label>Po Reg√°loch</ion-label>
      </ion-segment-button>
      <ion-segment-button value="global">
        <ion-label>V≈°etky</ion-label>
      </ion-segment-button>
      <ion-segment-button value="v_inventure" *ngIf="aktivnaInventura">
        <ion-label>Hotov√©</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>

  <div class="filter-panel">
    
    <div class="ion-padding-horizontal reset-container" 
          style="display: flex; justify-content: center; width: 100%;"
          *ngIf="vybranySkladId || searchQuery || (filterKategoria && filterKategoria !== 'vsetky')">
      
      <ion-chip color="danger" mode="ios" (click)="zrusitFiltre()">
        <ion-icon name="close-circle"></ion-icon>
        <ion-label>Zru≈°i≈• filtre</ion-label>
      </ion-chip>
    </div>

    <div class="select-row fade-in">
      
      <div class="select-wrapper">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
          <span class="input-label" style="margin-bottom: 0;">Sklad</span>
        </div>
        
        <div class="custom-input-box" [class.disabled]="rezimZobrazenia === 'global'">
          <ion-select placeholder="Vyberte" interface="action-sheet"
                      [(ngModel)]="vybranySkladId" 
                      (ionChange)="priZmeneSkladu()"
                      [disabled]="rezimZobrazenia === 'global'">
             <ion-select-option *ngFor="let s of sklady" [value]="s.id">
               {{ s.nazov }}
             </ion-select-option>
          </ion-select>
          <ion-icon name="caret-down-outline"></ion-icon>
        </div>
      </div>

      <div class="select-wrapper">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
          <span class="input-label" style="margin-bottom: 0;">Reg√°l</span>
        </div>
        
        <div class="custom-input-box" [class.disabled]="!vybranySkladId || rezimZobrazenia === 'global'">
          <ion-select placeholder="Vyberte" interface="action-sheet"
                      [(ngModel)]="vybranyRegalId" 
                      (ionChange)="priZmeneRegalu()"  
                      [disabled]="!vybranySkladId || rezimZobrazenia === 'global'">
             <ion-select-option *ngFor="let r of filtrovaneRegaly" [value]="r.id">
               {{ r.nazov }}
             </ion-select-option>
          </ion-select>
          <ion-icon name="caret-down-outline"></ion-icon>
        </div>
      </div>
    </div>

    <div class="toggle-row fade-in" *ngIf="rezimZobrazenia === 'regal' && !vybranyRegalId" style="padding: 0 16px; margin-bottom: 10px;">
      <ion-item lines="none" style="--background: transparent; --padding-start: 0; --inner-padding-end: 0;">
        <ion-label style="color: var(--ion-color-dark); font-size: 0.85rem; white-space: normal;">
          Zobrazi≈• v≈°etky polo≈æky zo skladu (aj bez vybran√©ho reg√°lu)
        </ion-label>
        <ion-toggle mode="ios" [(ngModel)]="zobrazitVsetkoVRegaloch" (ionChange)="obnovitZoznamPodlaRezimu()" color="primary"></ion-toggle>
      </ion-item>
    </div>
      
    <div *ngIf="(rezimZobrazenia === 'regal' && (vybranyRegalId || zobrazitVsetkoVRegaloch)) || rezimZobrazenia !== 'regal'" class="search-row fade-in">
      
      <ion-searchbar 
        placeholder="Hƒæada≈• produkt..."
        [(ngModel)]="searchQuery"
        (ionInput)="handleSearch($event)"
        [debounce]="500"
        mode="ios"
        class="custom-searchbar">
      </ion-searchbar>

      <div class="filter-btn-wrapper">
        <div class="icon-box">
          <ion-icon name="filter-outline"></ion-icon>
          <ion-select interface="action-sheet" 
                      [(ngModel)]="filterKategoria" 
                      (ionChange)="zmenitFilterKategorie($event)">
             <ion-select-option value="vsetky">V≈°etky</ion-select-option>
             <ion-select-option *ngFor="let k of zoznamKategorii" [value]="k">
               {{ k }}
             </ion-select-option>
          </ion-select>
        </div>
      </div>
    </div>
  </div>
</ion-header>

<ion-content #content [fullscreen]="true" class="bg-gray">

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div class="center-content" *ngIf="isLoading">
    <ion-spinner name="crescent" color="primary"></ion-spinner>
    <p>Naƒç√≠tavam...</p>
  </div>

  <div *ngIf="rezimZobrazenia === 'regal' && !vybranyRegalId && !zobrazitVsetkoVRegaloch && !isLoading" class="center-content empty-state fade-in">
    <div class="circle-icon">
      <ion-icon name="arrow-up-outline"></ion-icon>
    </div>
    <h3>Zaƒçnite v√Ωberom</h3>
    <p>Hore vyberte Sklad a Reg√°l pre zobrazenie tovaru.</p>
  </div>

  <div *ngIf="filtrovaneZasoby.length === 0 && !isLoading && (vybranyRegalId || zobrazitVsetkoVRegaloch || rezimZobrazenia !== 'regal')" class="center-content empty-state fade-in">
    <div class="circle-icon green-icon">
      <ion-icon [name]="rezimZobrazenia === 'v_inventure' ? 'checkmark-done-outline' : 'search-outline'"></ion-icon>
    </div>
    <h3 *ngIf="rezimZobrazenia === 'v_inventure'">Zatiaƒæ niƒç zap√≠san√©</h3>
    <h3 *ngIf="rezimZobrazenia !== 'v_inventure'">≈Ωiadne polo≈æky</h3>
    
    <p *ngIf="rezimZobrazenia === 'v_inventure'">V tejto invent√∫re ste e≈°te nepotvrdili ≈æiadny tovar.</p>
    <p *ngIf="rezimZobrazenia !== 'v_inventure'">Nena≈°li sa ≈æiadne produkty zodpovedaj√∫ce filtru.</p>
  </div>

  <div class="cards-list" *ngIf="!isLoading">
    
    <ion-list style="background: transparent;" lines="none">
      
      <ion-reorder-group [disabled]="isReorderDisabled" (ionItemReorder)="doReorder($event)">
        
        <ion-item *ngFor="let z of filtrovaneZasoby; trackBy: trackByZasoby" 
                  class="transparent-item"
                  style="--background: transparent; --padding-start: 0; --inner-padding-end: 0;">

          <ion-card [id]="'polozka-' + z.id" class="product-card" style="width: 100%; margin: 5px 12px;">
            <ion-card-content>
              <div class="card-container">

                <div class="card-left">
                  <div class="icon-placeholder" [class.done]="!jeAdmin && z.v_inventure">
  
                    <ng-container *ngIf="jeAdmin">
                      <span style="font-weight: 800; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;" 
                            [style.color]="z.v_inventure ? 'var(--ion-color-success, #2dd36f)' : 'var(--ion-color-medium, #92949c)'">
                        {{ z.id || z.produkt_id || '?' }}
                      </span>
                    </ng-container>
                  
                    <ng-container *ngIf="!jeAdmin">
                      <ion-icon *ngIf="z.v_inventure" name="checkmark-circle"></ion-icon>
                      <ion-icon *ngIf="!z.v_inventure" name="cube-outline"></ion-icon>
                    </ng-container>
                  
                  </div>
                  
                  <div class="info">
                    <div (click)="otvoritUpravu(z)">
                      <h3>{{ z.nazov }}</h3>
                    </div>

                    <div class="meta">
                      <span class="badge-cat">{{ z.kategoria || 'Bez kat.' }}</span>
                      <span *ngIf="z.balenie_ks > 0" class="badge-pack">üì¶ {{ z.balenie_ks }}</span>
                    </div>
                    
                    <p *ngIf="z.v_inventure" class="done-text">
                      <ion-icon name="checkmark-done-outline"></ion-icon> Zap√≠san√©
                    </p>
                    
                    <p *ngIf="z.umiestnenie" class="loc">
                      <ion-icon name="location-outline"></ion-icon> {{ z.umiestnenie }}
                    </p>
                  </div>
                </div>

                <div class="qty-box" (click)="otvoritUpravu(z)">
                  <ion-badge 
                      [color]="aktivnaInventura 
                              ? (z.v_inventure 
                                ? ($any(z).spocitane_mnozstvo == z.mnozstvo_ks ? 'success' : 'warning') 
                                : 'light') 
                              : 'light'" 
                      class="big-badge">
                    {{ aktivnaInventura ? ($any(z).spocitane_mnozstvo || 0) : z.mnozstvo_ks }}
                  </ion-badge>
                </div>

                <div class="info-actions">
                  <span class="action-icons" *ngIf="isReorderDisabled">
                    
                    <ion-button fill="clear" size="small" 
                                (click)="zobrazitPresunSklad(z, $event)"
                                *ngIf="z.id > 0"
                                title="Presun√∫≈•">
                        <ion-icon name="arrow-redo-outline" style="font-size: 1.2rem; color: var(--ion-color-tertiary);"></ion-icon>
                    </ion-button>
                
                    <ion-button *ngIf="jeAdmin" fill="clear" size="small" (click)="upravitProduktDetail(z); $event.stopPropagation()">
                        <ion-icon name="create-outline" style="font-size: 1.2rem;"></ion-icon>
                    </ion-button>
                    
                    <ion-icon 
                      *ngIf="jeAdmin && (z.id > 0 || z.v_inventure)"
                      name="trash-outline" color="danger" class="trash-icon"
                      (click)="zmazatPolozku(z, $event)">
                    </ion-icon>
                  </span>
                
                  <ion-reorder slot="end" *ngIf="!isReorderDisabled">
                     <ion-icon name="menu-outline" size="large" color="medium" style="margin-left: 10px;"></ion-icon>
                  </ion-reorder>
                </div>

              </div> 
            </ion-card-content>
          </ion-card>

        </ion-item>

      </ion-reorder-group>
    </ion-list>
  </div>

  <ion-infinite-scroll 
      *ngIf="rezimZobrazenia === 'v_inventure'" 
      threshold="100px" 
      (ionInfinite)="nacitatDalsieHotove($event)">
      
    <ion-infinite-scroll-content
      loadingSpinner="bubbles"
      loadingText="Naƒç√≠tavam ƒèal≈°ie...">
    </ion-infinite-scroll-content>
  </ion-infinite-scroll>

  <ion-fab 
    *ngIf="isReorderDisabled" 
    #draggableFab
    vertical="bottom" 
    horizontal="end" 
    slot="fixed" 
    class="draggable-fab"
    (touchstart)="onDragStart($event)"
    (touchmove)="onDragMove($event)"
    (touchend)="onDragEnd()"
    style="margin-bottom: calc(15px + var(--ion-safe-area-bottom))">
    
    <ion-fab-button (click)="otvoritNovyProdukt()" color="primary">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>